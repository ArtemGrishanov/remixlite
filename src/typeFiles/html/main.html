<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <style>
        /* Styles for preview generation */
        {{STYLES}}
    </style>
  </head>
  <body>
    <!-- Root element -->
    <div class="root" id="remix-app-root"></div>

    <script>
      let loadStatus = 0, loadStuff = 0, cntOrigin, cntSource, inited = false;
      let clientId = null

      if (window && window.localStorage) {
        clientId = window.localStorage.getItem("CLIENT_ID");
        if (!clientId) {
          clientId = getRandomId(16)
          window.localStorage.setItem("CLIENT_ID", clientId)
        }
      }

      window.addEventListener("message", receiveMessage, false);

      function receiveMessage({origin = null, data = {}, source = null}) {
        switch (data.method) {
          case 'init': {
            if (!inited) {
              if (!window.RemixLite) {
                sendMessage('init_error')
                throw new Error('RemixLite app not loaded!');
              }

              inited = true;

              const root = document.getElementById('remix-app-root');

              if (!data.payload.projectStructure) {
                data.payload.projectStructure = '{{PROJECT_STRUCTURE_JSON}}'
              }

              try {
                data.payload.projectStructure = JSON.parse(data.payload.projectStructure)
              } catch(err) {
                throw new Error('RemixLite cannot parse structure field to JSON');
              }

              if (data.payload.projectStructure.app.bg) {
                document.body.style.backgroundColor = data.payload.projectStructure.app.bg;
              }

              RemixLite.init({
                container: root,
                projectStructure: data.payload.projectStructure
              });

              sendMessage('initialized', {
                clientId,
                sizes: {
                  maxWidth: data.payload.projectStructure.app.maxWidth ? data.payload.projectStructure.app.maxWidth : 800,
                  height: root.scrollHeight
                },
              })

              const resizeObserver = new ResizeObserver(entries => {
                sendMessage('setSize', {
                  sizes: {
                    height: entries[0].target.scrollHeight
                  }
                })
              })
              resizeObserver.observe(root);

              ['mousemove', 'keydown'].forEach(evt => {
                window.addEventListener(evt, throttle(() => sendMessage('user-activity'), 5000))
              })
            }
            break;
          }
          case 'embed': {
            if (data.payload.js) {
              loadStuff++;
              const script = document.createElement('script');
              script.onload = checkAndReply.bind(this, true);
              script.setAttribute('src', data.payload.js);
              document.body.appendChild(script);
            }
            if (data.payload.css) {
              loadStuff++;
              const styles = document.createElement('link');
              styles.onload = checkAndReply.bind(this, true);
              styles.setAttribute('rel', 'stylesheet');
              styles.setAttribute('type', 'text/css');
              styles.setAttribute('href', data.payload.css);
              document.body.appendChild(styles);
            }
            cntSource = source;
            cntOrigin = !origin ? '*' : origin;
            checkAndReply();
            break;
          }
          default:
            break;
        }
      }
      function sendMessage(method, payload = null) {
        if (cntSource) {
          cntSource.postMessage({
            method,
            payload
          }, cntOrigin);
        }
      }

      function checkAndReply(loaded) {
        if (loaded) loadStatus++;
        if (cntSource && loadStatus === loadStuff) {
          sendMessage('embedded', {
            clientId
          })
        }
      }
      function getRandomId(t = 21) {
        let s = '',
                r = crypto.getRandomValues(new Uint8Array(t))
        for (; t--; ) {
          const n = 63 & r[t]
          s += n < 36 ? n.toString(36) : n < 62 ? (n - 26).toString(36).toUpperCase() : n < 63 ? '_' : '-'
        }
        return s
      }
      function throttle(func, waitTime) {
        let timeout = null
        return function (...args) {
          if (timeout === null) {
            func.apply(this, args)
            timeout = setTimeout(() => (timeout = null), waitTime)
          }
        }
      }

      // Scripts for preview generation
      try {
        {{SCRIPTS}}
        receiveMessage({data:{method:'init'}})
      }
      catch(err) {}
    </script>
  </body>
</html>