<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <style>
        /* Styles for preview generation */
        {{STYLES}}
    </style>
  </head>
  <body>
    <!-- Root element -->
    <div class="root" id="remix-app-root"></div>

    <script>
      let loadStatus = 0, loadStuff = 0, cntOrigin, cntSource, inited = false;
      let clientId = null

      if (window && window.localStorage) {
        clientId = window.localStorage.getItem("CLIENT_ID");
        if (!clientId) {
          clientId = getRandomId(16)
          window.localStorage.setItem("CLIENT_ID", clientId)
        }
      }

      window.addEventListener("message", receiveMessage, false);

      function receiveMessage({origin = null, data = {}, source = null}) {
        switch (data.method) {
          case 'init': {
            if (!inited) {
              if (!window.RemixLite) {
                throw new Error('RemixLite app not loaded! Be sure you passed correct script url.');
              }

              inited = true;

              const root = document.getElementById('remix-app-root');

              if (data.fixedRootWidth) {
                root.style.width = data.fixedRootWidth + 'px';
              }
              if (data.fixedRootHeight) {
                root.style.height = data.fixedRootHeight + 'px';
              }
              if (data.marginTop) {
                root.style.marginTop = data.marginTop + 'px';
              }
              if (data.marginBottom) {
                root.style.marginBottom = data.marginBottom + 'px';
              }
              if (data.lng) {
                try {
                  window.localStorage.setItem('lng', data.lng)
                } catch (err) {
                  console.error(err)
                }
              }

              if (data.defaults) {
                data.appStructure = data.defaults
              } else {
                data.appStructure = '{{PROJECT_STRUCTURE_JSON}}'
              }
              try {
                data.appStructure = JSON.parse(data.appStructure)
              } catch(err) {
                throw new Error('RemixLite cannot parse structure field to JSON');
              }

              if (data.appStructure.app.bg) {
                document.body.style.backgroundColor = data.appStructure.app.bg;
              }

              RemixLite.init({
                container: root,
                noRender: data.noRender,
                appStructure: data.appStructure
              });

              sendMessage({
                method: 'inited',
                appId: clientId,
                maxWidth: data.appStructure.app.maxWidth ? data.appStructure.app.maxWidth : 800,
                height: root.scrollHeight
              })

              const resizeObserver = new ResizeObserver(entries => {
                sendMessage({
                  method:'requestSetSize',
                  size: {
                    height: entries[0].target.scrollHeight
                  }
                })
              })
              resizeObserver.observe(root);

              ['mousemove', 'keydown'].forEach(evt => {
                window.addEventListener(evt, throttle(() => sendMessage({method: 'user-activity'}), 5000))
              })
            }
            break;
          }
          case 'embed': {
            if (data.script) {
              loadStuff++;
              const script = document.createElement('script');
              script.onload = checkAndReply.bind(this, true);
              script.setAttribute('src', data.script);
              document.body.appendChild(script);
            }
            if (data.css) {
              loadStuff++;
              const styles = document.createElement('link');
              styles.onload = checkAndReply.bind(this, true);
              styles.setAttribute('rel', 'stylesheet');
              styles.setAttribute('type', 'text/css');
              styles.setAttribute('href', data.css);
              document.body.appendChild(styles);
            }
            cntSource = source;
            cntOrigin = !origin ? '*' : origin;
            checkAndReply();
            break;
          }
          case 'setdata': {
            RemixLite.setData(data.data)
            sendMessage({
              method:'properties_updated'
            })
            break;
          }
          case 'serialize': {
            sendMessage({
              method: 'serialized',
              state: RemixLite.serialize()
            })
            break;
          }
          case 'setshareentities': {
            RemixLite.setData(data.data)
            break;
          }
          case 'getshareentities': {
            sendMessage({method: 'share_entities', share: RemixLite.getData().app.share})
            break;
          }
          default:
            break;
        }
      }
      function sendMessage(data) {
        if (cntSource) {
          cntSource.postMessage(data, cntOrigin);
        }
      }

      function checkAndReply(loaded) {
        if (loaded) loadStatus++;
        if (cntSource && loadStatus === loadStuff) {
          sendMessage({
            method:'embedded',
            appId: clientId,
          })
        }
      }
      function getRandomId(t = 21) {
        let s = '',
                r = crypto.getRandomValues(new Uint8Array(t))
        for (; t--; ) {
          const n = 63 & r[t]
          s += n < 36 ? n.toString(36) : n < 62 ? (n - 26).toString(36).toUpperCase() : n < 63 ? '_' : '-'
        }
        return s
      }
      function throttle(func, waitTime) {
        let timeout = null
        return function (...args) {
          if (timeout === null) {
            func.apply(this, args)
            timeout = setTimeout(() => (timeout = null), waitTime)
          }
        }
      }

      // Scripts for preview generation
      try {
        {{SCRIPTS}}
        receiveMessage({data:{method:'init'}})
      }
      catch(err) {}
    </script>
  </body>
</html>